{% extends 'base.html' %}
{% load static %}

{% block title %}AI Chat - OneLastAI{% endblock %}

{% block content %}
<div class="h-full flex" x-data="chatApp()" x-init="initChat()">
    <!-- Chat Sidebar -->
    <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">AI Agents</h2>
                <button 
                    x-on:click="showNewChatModal = true"
                    class="p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100"
                    title="New Chat"
                >
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>

        <!-- Agent Categories -->
        <div class="flex-1 overflow-y-auto">
            <!-- Recent Conversations -->
            <div class="px-6 py-4">
                <h3 class="text-sm font-medium text-gray-500 mb-3">Recent Conversations</h3>
                <div class="space-y-2">
                    <template x-for="conversation in recentConversations" :key="conversation.id">
                        <div 
                            class="p-3 rounded-lg cursor-pointer transition-colors"
                            :class="selectedConversation?.id === conversation.id ? 'bg-blue-50 border border-blue-200' : 'hover:bg-gray-50 border border-transparent'"
                            x-on:click="loadConversation(conversation)"
                        >
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center">
                                        <i :class="conversation.agent.icon" class="text-white text-xs"></i>
                                    </div>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <p class="text-sm font-medium text-gray-900 truncate" x-text="conversation.agent.name"></p>
                                    <p class="text-xs text-gray-500 truncate" x-text="conversation.last_message || 'No messages yet'"></p>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Empty state -->
                    <div x-show="recentConversations.length === 0" class="text-center py-8">
                        <i class="fas fa-comments text-gray-300 text-3xl mb-3"></i>
                        <p class="text-gray-500 text-sm">No conversations yet</p>
                    </div>
                </div>
            </div>

            <!-- Available Agents -->
            <div class="px-6 py-4 border-t border-gray-100">
                <h3 class="text-sm font-medium text-gray-500 mb-3">Available Agents</h3>
                
                <!-- Agent Categories -->
                <div class="space-y-4">
                    <!-- Conversational Agents -->
                    <div>
                        <button 
                            class="w-full flex items-center justify-between p-2 text-left text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md"
                            x-data="{ open: true }"
                            x-on:click="open = !open"
                        >
                            <span>Conversational</span>
                            <i class="fas fa-chevron-down transition-transform" :class="{ 'rotate-180': open }"></i>
                        </button>
                        <div class="mt-2 space-y-1 pl-2" x-show="open">
                            <template x-for="agent in agents.conversational" :key="agent.id">
                                <button 
                                    class="w-full flex items-center space-x-2 p-2 text-left text-sm text-gray-600 hover:bg-gray-50 rounded-md"
                                    x-on:click="startNewChat(agent)"
                                >
                                    <div class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center">
                                        <i :class="agent.icon" class="text-white text-xs"></i>
                                    </div>
                                    <span x-text="agent.name"></span>
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- Technical Agents -->
                    <div>
                        <button 
                            class="w-full flex items-center justify-between p-2 text-left text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md"
                            x-data="{ open: false }"
                            x-on:click="open = !open"
                        >
                            <span>Technical</span>
                            <i class="fas fa-chevron-down transition-transform" :class="{ 'rotate-180': open }"></i>
                        </button>
                        <div class="mt-2 space-y-1 pl-2" x-show="open">
                            <template x-for="agent in agents.technical" :key="agent.id">
                                <button 
                                    class="w-full flex items-center space-x-2 p-2 text-left text-sm text-gray-600 hover:bg-gray-50 rounded-md"
                                    x-on:click="startNewChat(agent)"
                                >
                                    <div class="w-6 h-6 rounded-full bg-gradient-to-br from-indigo-400 to-indigo-600 flex items-center justify-center">
                                        <i :class="agent.icon" class="text-white text-xs"></i>
                                    </div>
                                    <span x-text="agent.name"></span>
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- Creative Agents -->
                    <div>
                        <button 
                            class="w-full flex items-center justify-between p-2 text-left text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md"
                            x-data="{ open: false }"
                            x-on:click="open = !open"
                        >
                            <span>Creative</span>
                            <i class="fas fa-chevron-down transition-transform" :class="{ 'rotate-180': open }"></i>
                        </button>
                        <div class="mt-2 space-y-1 pl-2" x-show="open">
                            <template x-for="agent in agents.creative" :key="agent.id">
                                <button 
                                    class="w-full flex items-center space-x-2 p-2 text-left text-sm text-gray-600 hover:bg-gray-50 rounded-md"
                                    x-on:click="startNewChat(agent)"
                                >
                                    <div class="w-6 h-6 rounded-full bg-gradient-to-br from-pink-400 to-pink-600 flex items-center justify-center">
                                        <i :class="agent.icon" class="text-white text-xs"></i>
                                    </div>
                                    <span x-text="agent.name"></span>
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- Business Agents -->
                    <div>
                        <button 
                            class="w-full flex items-center justify-between p-2 text-left text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md"
                            x-data="{ open: false }"
                            x-on:click="open = !open"
                        >
                            <span>Business</span>
                            <i class="fas fa-chevron-down transition-transform" :class="{ 'rotate-180': open }"></i>
                        </button>
                        <div class="mt-2 space-y-1 pl-2" x-show="open">
                            <template x-for="agent in agents.business" :key="agent.id">
                                <button 
                                    class="w-full flex items-center space-x-2 p-2 text-left text-sm text-gray-600 hover:bg-gray-50 rounded-md"
                                    x-on:click="startNewChat(agent)"
                                >
                                    <div class="w-6 h-6 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center">
                                        <i :class="agent.icon" class="text-white text-xs"></i>
                                    </div>
                                    <span x-text="agent.name"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="flex-1 flex flex-col">
        <!-- Chat Header -->
        <div x-show="selectedConversation" class="px-6 py-4 border-b border-gray-200 bg-white">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center">
                        <i :class="selectedConversation?.agent.icon" class="text-white text-sm"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900" x-text="selectedConversation?.agent.name"></h3>
                        <p class="text-sm text-gray-500" x-text="selectedConversation?.agent.description"></p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2">
                    <!-- Voice Chat Toggle -->
                    <button 
                        class="p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100"
                        :class="{ 'text-green-600': voiceEnabled }"
                        x-on:click="toggleVoiceChat()"
                        title="Voice Chat"
                    >
                        <i class="fas fa-microphone"></i>
                    </button>
                    
                    <!-- Settings -->
                    <button 
                        class="p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100"
                        x-on:click="showChatSettings = true"
                        title="Chat Settings"
                    >
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Welcome Screen -->
        <div x-show="!selectedConversation" class="flex-1 flex items-center justify-center bg-gray-50">
            <div class="text-center max-w-md">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl mx-auto mb-6 flex items-center justify-center">
                    <i class="fas fa-robot text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Welcome to OneLastAI</h3>
                <p class="text-gray-600 mb-6">Choose an AI agent from the sidebar to start a conversation, or create a new chat session.</p>
                <button 
                    x-on:click="showNewChatModal = true"
                    class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                >
                    <i class="fas fa-plus mr-2"></i>
                    Start New Chat
                </button>
            </div>
        </div>

        <!-- Messages Area -->
        <div x-show="selectedConversation" class="flex-1 overflow-y-auto p-6 bg-gray-50" x-ref="messagesContainer">
            <div class="space-y-4">
                <template x-for="message in messages" :key="message.id">
                    <div class="flex" :class="message.sender === 'user' ? 'justify-end' : 'justify-start'">
                        <div class="max-w-xs lg:max-w-md">
                            <!-- User Message -->
                            <div x-show="message.sender === 'user'" class="chat-bubble-user">
                                <p class="text-sm" x-text="message.content"></p>
                                <p class="text-xs opacity-75 mt-1" x-text="formatTime(message.timestamp)"></p>
                            </div>
                            
                            <!-- AI Message -->
                            <div x-show="message.sender === 'ai'" class="chat-bubble-ai">
                                <div class="flex items-start space-x-2 mb-2">
                                    <div class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center flex-shrink-0">
                                        <i :class="selectedConversation.agent.icon" class="text-white text-xs"></i>
                                    </div>
                                    <span class="text-xs font-medium text-gray-600" x-text="selectedConversation.agent.name"></span>
                                </div>
                                <div class="prose prose-sm max-w-none" x-html="formatMessage(message.content)"></div>
                                <p class="text-xs text-gray-500 mt-2" x-text="formatTime(message.timestamp)"></p>
                                
                                <!-- Message Actions -->
                                <div class="flex items-center space-x-2 mt-2">
                                    <button 
                                        class="text-xs text-gray-400 hover:text-gray-600"
                                        x-on:click="copyMessage(message.content)"
                                    >
                                        <i class="fas fa-copy mr-1"></i>Copy
                                    </button>
                                    <button 
                                        class="text-xs text-gray-400 hover:text-gray-600"
                                        x-on:click="regenerateMessage(message.id)"
                                    >
                                        <i class="fas fa-redo mr-1"></i>Regenerate
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
                
                <!-- Typing Indicator -->
                <div x-show="isTyping" class="flex justify-start">
                    <div class="max-w-xs lg:max-w-md">
                        <div class="chat-bubble-ai">
                            <div class="flex items-center space-x-2">
                                <div class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center">
                                    <i :class="selectedConversation?.agent.icon" class="text-white text-xs"></i>
                                </div>
                                <div class="flex space-x-1">
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Input -->
        <div x-show="selectedConversation" class="p-6 bg-white border-t border-gray-200">
            <form x-on:submit.prevent="sendMessage()" class="flex space-x-4">
                <div class="flex-1">
                    <div class="relative">
                        <textarea
                            x-model="newMessage"
                            x-ref="messageInput"
                            x-on:keydown.enter.prevent="sendMessage()"
                            x-on:keydown.shift.enter.prevent="$refs.messageInput.value += '\n'"
                            placeholder="Type your message... (Enter to send, Shift+Enter for new line)"
                            rows="1"
                            class="w-full resize-none rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 pr-12"
                            :disabled="isLoading"
                        ></textarea>
                        
                        <!-- Attachment Button -->
                        <button
                            type="button"
                            class="absolute right-2 top-2 p-1 text-gray-400 hover:text-gray-600 rounded"
                            title="Attach File"
                        >
                            <i class="fas fa-paperclip"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Voice Input -->
                <button
                    type="button"
                    class="p-3 text-gray-400 hover:text-gray-600 rounded-lg border border-gray-300 hover:bg-gray-50"
                    :class="{ 'text-red-500 bg-red-50': isRecording }"
                    x-on:click="toggleVoiceInput()"
                    title="Voice Input"
                >
                    <i class="fas fa-microphone"></i>
                </button>
                
                <!-- Send Button -->
                <button
                    type="submit"
                    class="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    :disabled="!newMessage.trim() || isLoading"
                >
                    <i class="fas fa-paper-plane" x-show="!isLoading"></i>
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white" x-show="isLoading"></div>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div x-show="showNewChatModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" x-on:click="showNewChatModal = false"></div>
        
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Start New Chat</h3>
                <p class="text-sm text-gray-500 mb-4">Choose an AI agent to start a conversation with:</p>
                
                <div class="grid grid-cols-1 gap-3">
                    <template x-for="category in Object.keys(agents)" :key="category">
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2 capitalize" x-text="category"></h4>
                            <div class="grid grid-cols-2 gap-2">
                                <template x-for="agent in agents[category]" :key="agent.id">
                                    <button
                                        class="p-3 text-left rounded-md border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-colors"
                                        x-on:click="startNewChat(agent); showNewChatModal = false"
                                    >
                                        <div class="flex items-center space-x-2">
                                            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center">
                                                <i :class="agent.icon" class="text-white text-xs"></i>
                                            </div>
                                            <div>
                                                <p class="text-sm font-medium text-gray-900" x-text="agent.name"></p>
                                            </div>
                                        </div>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button
                    type="button"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                    x-on:click="showNewChatModal = false"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function chatApp() {
    return {
        // State
        selectedConversation: null,
        messages: [],
        newMessage: '',
        isLoading: false,
        isTyping: false,
        isRecording: false,
        voiceEnabled: false,
        showNewChatModal: false,
        showChatSettings: false,
        
        // Data
        recentConversations: [],
        agents: {
            conversational: [
                { id: 'personal-assistant', name: 'Personal Assistant', icon: 'fas fa-user-tie', description: 'Your intelligent personal assistant' },
                { id: 'customer-support', name: 'Customer Support', icon: 'fas fa-headset', description: 'Professional customer service' },
                { id: 'language-tutor', name: 'Language Tutor', icon: 'fas fa-language', description: 'Expert language instructor' },
                { id: 'therapist', name: 'Therapist', icon: 'fas fa-heart', description: 'Supportive mental health companion' }
            ],
            technical: [
                { id: 'code-reviewer', name: 'Code Reviewer', icon: 'fas fa-code', description: 'Expert code analysis and review' },
                { id: 'security-auditor', name: 'Security Auditor', icon: 'fas fa-shield-alt', description: 'Cybersecurity specialist' },
                { id: 'devops-engineer', name: 'DevOps Engineer', icon: 'fas fa-cogs', description: 'Infrastructure automation expert' },
                { id: 'data-scientist', name: 'Data Scientist', icon: 'fas fa-chart-bar', description: 'Advanced analytics specialist' }
            ],
            creative: [
                { id: 'content-writer', name: 'Content Writer', icon: 'fas fa-pen-fancy', description: 'Professional content creator' },
                { id: 'social-media-manager', name: 'Social Media Manager', icon: 'fas fa-hashtag', description: 'Social media expert' },
                { id: 'image-generator', name: 'Image Generator', icon: 'fas fa-image', description: 'AI-powered image creation' },
                { id: 'video-generator', name: 'Video Generator', icon: 'fas fa-video', description: 'Advanced video creation' }
            ],
            business: [
                { id: 'financial-advisor', name: 'Financial Advisor', icon: 'fas fa-dollar-sign', description: 'Investment and financial planning' },
                { id: 'legal-consultant', name: 'Legal Consultant', icon: 'fas fa-gavel', description: 'Legal guidance and advice' },
                { id: 'project-manager', name: 'Project Manager', icon: 'fas fa-tasks', description: 'Project planning and coordination' },
                { id: 'sales-coach', name: 'Sales Coach', icon: 'fas fa-handshake', description: 'Sales strategy expert' }
            ]
        },
        
        // WebSocket
        socket: null,
        
        // Initialize
        async initChat() {
            await this.loadRecentConversations();
            this.setupWebSocket();
        },
        
        // Load recent conversations
        async loadRecentConversations() {
            try {
                const response = await fetch('/api/agents/conversations/', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    this.recentConversations = await response.json();
                }
            } catch (error) {
                console.error('Failed to load conversations:', error);
            }
        },
        
        // WebSocket setup
        setupWebSocket() {
            if (this.selectedConversation) {
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws/agents/${this.selectedConversation.agent.id}/chat/`;
                
                this.socket = new WebSocket(wsUrl);
                
                this.socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };
                
                this.socket.onclose = () => {
                    console.log('WebSocket connection closed');
                };
                
                this.socket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            }
        },
        
        // Handle WebSocket messages
        handleWebSocketMessage(data) {
            switch (data.type) {
                case 'agent_message':
                    this.messages.push({
                        id: Date.now(),
                        sender: 'ai',
                        content: data.message,
                        timestamp: new Date()
                    });
                    this.isTyping = false;
                    this.scrollToBottom();
                    break;
                    
                case 'agent_typing':
                    this.isTyping = true;
                    this.scrollToBottom();
                    break;
                    
                case 'error':
                    showNotification(data.message, 'error');
                    this.isLoading = false;
                    this.isTyping = false;
                    break;
            }
        },
        
        // Start new chat
        async startNewChat(agent) {
            this.selectedConversation = {
                id: null,
                agent: agent,
                created_at: new Date()
            };
            
            this.messages = [];
            this.setupWebSocket();
            
            // Add welcome message
            this.messages.push({
                id: Date.now(),
                sender: 'ai',
                content: `Hello! I'm ${agent.name}. ${agent.description}. How can I help you today?`,
                timestamp: new Date()
            });
            
            this.scrollToBottom();
        },
        
        // Load existing conversation
        async loadConversation(conversation) {
            this.selectedConversation = conversation;
            
            try {
                const response = await fetch(`/api/agents/conversations/${conversation.id}/messages/`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    this.messages = await response.json();
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
            
            this.setupWebSocket();
            this.scrollToBottom();
        },
        
        // Send message
        async sendMessage() {
            if (!this.newMessage.trim() || this.isLoading) return;
            
            const message = this.newMessage.trim();
            this.newMessage = '';
            this.isLoading = true;
            
            // Add user message
            this.messages.push({
                id: Date.now(),
                sender: 'user',
                content: message,
                timestamp: new Date()
            });
            
            this.scrollToBottom();
            
            // Send via WebSocket
            if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                this.socket.send(JSON.stringify({
                    type: 'user_message',
                    message: message,
                    conversation_id: this.selectedConversation?.id
                }));
            } else {
                // Fallback to HTTP
                await this.sendMessageHTTP(message);
            }
            
            this.isLoading = false;
        },
        
        // Send message via HTTP (fallback)
        async sendMessageHTTP(message) {
            try {
                const response = await fetch('/api/agents/chat/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        agent_id: this.selectedConversation.agent.id,
                        message: message,
                        conversation_id: this.selectedConversation?.id
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update conversation ID if new
                    if (!this.selectedConversation.id) {
                        this.selectedConversation.id = data.conversation_id;
                    }
                    
                    // Add AI response
                    this.messages.push({
                        id: Date.now(),
                        sender: 'ai',
                        content: data.response,
                        timestamp: new Date()
                    });
                    
                    this.scrollToBottom();
                } else {
                    throw new Error('Failed to send message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Failed to send message. Please try again.', 'error');
            }
        },
        
        // Utility functions
        scrollToBottom() {
            this.$nextTick(() => {
                if (this.$refs.messagesContainer) {
                    this.$refs.messagesContainer.scrollTop = this.$refs.messagesContainer.scrollHeight;
                }
            });
        },
        
        formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        },
        
        formatMessage(content) {
            // Simple markdown-like formatting
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        },
        
        copyMessage(content) {
            navigator.clipboard.writeText(content).then(() => {
                showNotification('Message copied to clipboard', 'success');
            });
        },
        
        regenerateMessage(messageId) {
            // Find the message and regenerate
            const messageIndex = this.messages.findIndex(m => m.id === messageId);
            if (messageIndex > 0) {
                const previousMessage = this.messages[messageIndex - 1];
                if (previousMessage.sender === 'user') {
                    // Remove the AI message and resend the user message
                    this.messages.splice(messageIndex, 1);
                    this.sendMessageHTTP(previousMessage.content);
                }
            }
        },
        
        toggleVoiceChat() {
            this.voiceEnabled = !this.voiceEnabled;
            showNotification(
                this.voiceEnabled ? 'Voice chat enabled' : 'Voice chat disabled',
                'info'
            );
        },
        
        toggleVoiceInput() {
            if (!this.isRecording) {
                this.startVoiceRecording();
            } else {
                this.stopVoiceRecording();
            }
        },
        
        startVoiceRecording() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onstart = () => {
                    this.isRecording = true;
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    this.newMessage = transcript;
                    this.isRecording = false;
                };
                
                recognition.onerror = () => {
                    this.isRecording = false;
                    showNotification('Voice recognition failed', 'error');
                };
                
                recognition.onend = () => {
                    this.isRecording = false;
                };
                
                recognition.start();
            } else {
                showNotification('Voice recognition not supported', 'error');
            }
        },
        
        stopVoiceRecording() {
            this.isRecording = false;
        }
    };
}
</script>
{% endblock %}